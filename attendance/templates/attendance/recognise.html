{% extends "base.html" %}
{% load static %}
{% block title %}Recognise{% endblock %}
{% block content %}
<h1 class="mb-4">Recognise &amp; Mark Attendance</h1>
<video id="cam" autoplay playsinline class="border rounded w-100 w-md-50"></video>
<p id="status" class="mt-3 fw-semibold"></p>

<script>
(async () => {
  const v = document.getElementById('cam'), s = document.getElementById('status');
  try { v.srcObject = await navigator.mediaDevices.getUserMedia({video:true}); }
  catch { s.textContent = "Webcam denied"; return; }

  const c=document.createElement('canvas'), ctx=c.getContext('2d',{willReadFrequently:true});
  let last=null;

  setInterval(()=>{ if(!v.videoWidth)return;
    c.width=v.videoWidth; c.height=v.videoHeight;
    ctx.drawImage(v,0,0);
    const data=ctx.getImageData(0,0,c.width,c.height).data;
    let diff=0;
    if(last){
      for(let i=0;i<data.length;i+=4) diff+=Math.abs(data[i]-last[i]);
      diff/=data.length/4;
    }
    last=data;
    if(diff<15) return;                // no motion → skip

    fetch("{% url 'recognise_api' %}",{
      method:"POST",
      headers:{
        "X-Frame-Data":c.toDataURL("image/jpeg"),"X-Live":"1","X-CSRFToken":"{{ csrf_token }}"
      }
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.match){
        s.textContent=`✅ ${res.name} marked present`;
        s.className="text-success fw-bold mt-2";
      }else{
        s.textContent="❌ Unknown face";
        s.className="text-danger fw-bold mt-2";
      }
    });
  },2000);
})();
</script>
{% endblock %}
